from flask import Flask, redirect, url_for, session
from auth import auth_bp
from director import director_bp
from employee import employee_bp
from models import initialize_work_time_file
import socket
import os

app = Flask(__name__)
app.secret_key = 'your_secret_key_here'  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –∫–ª—é—á

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Blueprints
app.register_blueprint(auth_bp)
app.register_blueprint(director_bp)
app.register_blueprint(employee_bp)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
initialize_work_time_file()

@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏"""
    if 'username' in session:
        if session['role'] == 'director':
            return redirect(url_for('director.director_dashboard'))
        else:
            return redirect(url_for('employee.employee_dashboard'))
    return redirect(url_for('auth.login'))

def get_local_ip():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∞"""
    try:
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å IP
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        ip = s.getsockname()[0]
        s.close()
        return ip
    except:
        return "127.0.0.1"

if __name__ == '__main__':
    # –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π IP
    local_ip = get_local_ip()
    port = 5000
    
    print("\n" + "="*50)
    print("üöÄ –°–∞–π—Ç –∑–∞–ø—É—â–µ–Ω!")
    print("="*50)
    print(f"üì± –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–æ—Å—Ç—É–ø: http://127.0.0.1:{port}")
    print(f"üåê –°–µ—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø: http://{local_ip}:{port}")
    print("="*50)
    print("–ß—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä, –Ω–∞–∂–º–∏—Ç–µ Ctrl+C")
    print("="*50 + "\n")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä
    app.run(
        host='0.0.0.0',  # –ü—Ä–∏–Ω–∏–º–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–æ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
        port=port,
        debug=True,
        threaded=True  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    )